# DB-4 マイクロサービス基盤（サービス間データ一貫性）

## 概要

マイクロサービスアーキテクチャを採用すると、各サービスが独自のDBを持ち、サービス間でデータを同期するためにSagaパターンやイベント駆動連携が用いられる。しかし、複数サービスに跨るトランザクションを扱う場合や共通マスタを共有する場合、整合性を保つのが難しい。このユースケースは、マイクロサービス間での強い整合性を確保するためのデータ基盤である。

## ビジネス課題

- ECやサブスクリプションビジネスでは注文・在庫・決済など複数サービスが連携し、誤発注や二重請求を防ぐため強い整合性が求められる。
- 新機能追加のためにサービスを増やすと、データ同期の複雑さと障害発生時のロールバックが課題となる。

## システム課題

- Sagaパターンやイベントベース連携では整合性を最終的にしか保証できず、途中で失敗するとリカバリが複雑。
- 共通マスタ（顧客、商品、会員など）を複数サービスで共有する際、どのサービスが正本か不明確になる。

## 対象データ・環境

- マイクロサービスごとに分散したRDB/NoSQL。
- 共通マスタや注文データ、会員履歴などの共有が必要なデータ。
- クラウドネイティブなコンテナ基盤やサービスメッシュが採用されている環境。

## 導入目的・効果

- 複数サービスに跨る処理でもACIDトランザクションを確実に実行し、誤注文や重複処理を防止。
- Sagaパターンのような回復処理実装を簡素化し、アプリケーション開発負担を減らす。
- 共通マスタデータを一貫して更新できる仕組みにより、マスタの一元性を維持。

## 解決方法（ソリューション概要）

ScalarDBが提供する分散トランザクション機能を用いて、サービス間のトランザクションを強い整合性のもとで実行する。各マイクロサービスは自身のDBに対して従来通りクエリを発行するが、ScalarDBを経由することで複数DBへの一括更新が保証される。これにより、Sagaパターンの複雑な補償処理を実装する必要がなくなり、開発工数を削減できる。統一認証やABACによりサービスごとのアクセス権限も安全に管理できる。

## システム構成

- サービスごとにデータストアを持つが、共通データや複数サービスに跨る処理はScalarDBを経由して実行。
- アプリケーションはScalarDBのトランザクションマネージャーを用いて複数DBへの更新を行い、失敗時には自動でロールバックされる。
- サービスメッシュやAPIゲートウェイと連携して、マイクロサービスの通信経路を制御。

## 導入メリット／ROI

- 強い整合性を保証することで、ビジネスロジックの複雑さを大幅に軽減し、サービスリリースまでの時間を短縮。
- エラー時のリトライや補償処理の実装が不要になり、運用コストが削減。
- 共通マスタのデータ品質が向上し、カスタマーエクスペリエンスや分析精度も改善。

## 類似事例・参考資料

- オンライン決済サービスやEC企業が、マイクロサービス間の注文と在庫更新をScalarDBで統合し、在庫誤差を解消した事例がある。
- ScalarDBが提供する分散トランザクションにより複数DB間で一貫性のある処理が可能なことは、公式サイトで説明されている（参考: [scalar-labs.com](https://scalar-labs.com)）。

